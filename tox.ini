[tox]
envlist = py{310,312}, black, prospector, bandit, mypy

[testenv]
change_dir = app
description = Run unit tests
commands = python3 -m unittest
deps =
    -r requirements.txt
    -r requirements-dev.txt

[testenv:black]
description = Check code style
deps =
    -r requirements.txt
    -r requirements-dev.txt
commands = black --check .
skip_install = true

[testenv:prospector]
description = Run static analysis using prospector
deps =
    -r requirements.txt
    -r requirements-dev.txt
commands = prospector --no-autodetect \
               --doc-warnings \
               --test-warnings \
               --zero-exit \
               .

[testenv:mypy]
description = Check typing
deps =
    -r requirements.txt
    -r requirements-dev.txt
commands = mypy --follow-imports skip \
    --ignore-missing-imports \
    .
skip_install = true

[testenv:bandit]
description = Check for security issues
deps =
    -r requirements.txt
    -r requirements-dev.txt
commands = bandit --recursive .
skip_install = true

[testenv:sedr]
change_dir = app
description = WIP! Start app in background, wait for startup, run sedr to validate API, kill background process based on port number.
deps =
    -r requirements.txt
    -r requirements-dev.txt
allowlist_externals =
    bash
    docker
commands_pre = bash -c 'python app.py & sleep 5'
commands = docker run -it --network=host --rm sedr --openapi http://localhost:5000/api --url http://localhost:5000
commands_post = bash -c 'kill $(lsof -t -i:5000)'

[testenv:lintgitlab]
change_dir = {tox_root}
description = Lint gitlab-ci
commands = yamllint .gitlab-ci.yml
deps =
    -r requirements-dev.txt
ignore_outcome = true
